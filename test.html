<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©æ°”åº”ç”¨æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 300px;
        }
        .location-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ¤ï¸ 3D å¤©æ°”åº”ç”¨æµ‹è¯•</h1>
        <p>è¿™ä¸ªé¡µé¢å¸®åŠ©ä½ æµ‹è¯•å¤©æ°”åº”ç”¨çš„å„é¡¹åŠŸèƒ½</p>
        
        <div class="test-section">
            <h2>ğŸ” åœ°ç†ä½ç½®æµ‹è¯•</h2>
            <button onclick="testGeolocation()">æµ‹è¯•è·å–å½“å‰ä½ç½®</button>
            <button onclick="requestLocationPermission()">è¯·æ±‚ä½ç½®æƒé™</button>
            <div id="locationResult" class="location-status"></div>
        </div>

        <div class="test-section">
            <h2>ğŸŒ¡ï¸ å¤©æ°” API æµ‹è¯•</h2>
            <button onclick="testDirectAPI()">æµ‹è¯•ç›´æ¥ WeatherAPI</button>
            <button onclick="testVercelAPI()">æµ‹è¯• Vercel API è·¯ç”±</button>
            <button onclick="testLocalAPI()">æµ‹è¯•æœ¬åœ° API</button>
            <div id="weatherResult"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”§ ç¯å¢ƒæ£€æŸ¥</h2>
            <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒå˜é‡</button>
            <div id="envResult"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“± åº”ç”¨çŠ¶æ€</h2>
            <div id="appStatus"></div>
        </div>
    </div>

    <script>
        const API_KEY = '14b98029813d49acbc1101959251611';
        const VERCEL_API_URL = 'https://3d-weather-codrops-main-biq1za6yf-ailoen1s-projects.vercel.app/api/weather';
        
        // æ£€æŸ¥åº”ç”¨çŠ¶æ€
        function updateAppStatus() {
            const statusDiv = document.getElementById('appStatus');
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isHTTPS = window.location.protocol === 'https:';
            
            statusDiv.innerHTML = `
                <div class="info">
                    <strong>å½“å‰ç¯å¢ƒ:</strong> ${isLocalhost ? 'æœ¬åœ°å¼€å‘' : 'ç”Ÿäº§ç¯å¢ƒ'}<br>
                    <strong>åè®®:</strong> ${window.location.protocol}<br>
                    <strong>ä¸»æœº:</strong> ${window.location.hostname}<br>
                    <strong>API Key:</strong> ${API_KEY ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}<br>
                    <strong>åœ°ç†ä½ç½®æ”¯æŒ:</strong> ${'geolocation' in navigator ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}
                </div>
            `;
        }

        // æµ‹è¯•åœ°ç†ä½ç½®
        function testGeolocation() {
            const resultDiv = document.getElementById('locationResult');
            
            if (!('geolocation' in navigator)) {
                resultDiv.innerHTML = '<div class="error">æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="info">æ­£åœ¨è·å–ä½ç½®...</div>';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>ä½ç½®è·å–æˆåŠŸ!</strong><br>
                            çº¬åº¦: ${latitude}<br>
                            ç»åº¦: ${longitude}<br>
                            ç²¾åº¦: ${accuracy}ç±³<br>
                            <button onclick="testWeatherByCoords(${latitude}, ${longitude})">ç”¨æ­¤åæ ‡æµ‹è¯•å¤©æ°”</button>
                        </div>
                    `;
                },
                (error) => {
                    let errorMessage = 'æœªçŸ¥é”™è¯¯';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'ç”¨æˆ·æ‹’ç»äº†åœ°ç†ä½ç½®æƒé™';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'è·å–ä½ç½®è¶…æ—¶';
                            break;
                    }
                    resultDiv.innerHTML = `<div class="error"><strong>ä½ç½®è·å–å¤±è´¥:</strong> ${errorMessage}</div>`;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 600000
                }
            );
        }

        // è¯·æ±‚ä½ç½®æƒé™
        function requestLocationPermission() {
            const resultDiv = document.getElementById('locationResult');
            
            if (!('permissions' in navigator)) {
                resultDiv.innerHTML = '<div class="error">æµè§ˆå™¨ä¸æ”¯æŒæƒé™ API</div>';
                return;
            }

            navigator.permissions.query({ name: 'geolocation' })
                .then((result) => {
                    resultDiv.innerHTML = `
                        <div class="info">
                            <strong>åœ°ç†ä½ç½®æƒé™çŠ¶æ€:</strong> ${result.state}<br>
                            ${result.state === 'prompt' ? 'éœ€è¦ç”¨æˆ·æˆæƒ' : result.state === 'granted' ? 'å·²æˆæƒ' : 'å·²æ‹’ç»'}
                        </div>
                    `;
                    
                    if (result.state === 'prompt') {
                        testGeolocation(); // è§¦å‘æƒé™è¯·æ±‚
                    }
                })
                .catch((error) => {
                    resultDiv.innerHTML = `<div class="error">æƒé™æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
                });
        }

        // æµ‹è¯•ç›´æ¥ WeatherAPI
        async function testDirectAPI() {
            const resultDiv = document.getElementById('weatherResult');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•ç›´æ¥ WeatherAPI...</div>';
            
            try {
                const response = await fetch(`https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=Beijing&days=3`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>âœ… ç›´æ¥ WeatherAPI æµ‹è¯•æˆåŠŸ!</strong><br>
                            ä½ç½®: ${data.location.name}, ${data.location.country}<br>
                            æ¸©åº¦: ${data.current.temp_c}Â°C<br>
                            å¤©æ°”: ${data.current.condition.text}<br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <strong>âŒ ç›´æ¥ WeatherAPI æµ‹è¯•å¤±è´¥</strong><br>
                            çŠ¶æ€: ${response.status}<br>
                            é”™è¯¯: ${data.error?.message || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><strong>ç½‘ç»œé”™è¯¯:</strong> ${error.message}</div>`;
            }
        }

        // æµ‹è¯• Vercel API è·¯ç”±
        async function testVercelAPI() {
            const resultDiv = document.getElementById('weatherResult');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯• Vercel API è·¯ç”±...</div>';
            
            try {
                const response = await fetch(`${VERCEL_API_URL}?location=Beijing`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>âœ… Vercel API è·¯ç”±æµ‹è¯•æˆåŠŸ!</strong><br>
                            ä½ç½®: ${data.location.name}, ${data.location.country}<br>
                            æ¸©åº¦: ${data.current.temp_c}Â°C<br>
                            å¤©æ°”: ${data.current.condition.text}<br>
                            ${data.cached ? `ğŸ”„ ç¼“å­˜æ•°æ® (${data.cacheAge}ç§’å‰)` : 'ğŸ†• æ–°é²œæ•°æ®'}
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <strong>âŒ Vercel API è·¯ç”±æµ‹è¯•å¤±è´¥</strong><br>
                            çŠ¶æ€: ${response.status}<br>
                            é”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><strong>ç½‘ç»œé”™è¯¯:</strong> ${error.message}</div>`;
            }
        }

        // æµ‹è¯•æœ¬åœ° APIï¼ˆåœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼‰
        async function testLocalAPI() {
            const resultDiv = document.getElementById('weatherResult');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•æœ¬åœ° API...</div>';
            
            try {
                const response = await fetch(`/api/weather?location=Beijing`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>âœ… æœ¬åœ° API æµ‹è¯•æˆåŠŸ!</strong><br>
                            ä½ç½®: ${data.location.name}, ${data.location.country}<br>
                            æ¸©åº¦: ${data.current.temp_c}Â°C<br>
                            å¤©æ°”: ${data.current.condition.text}<br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <strong>âŒ æœ¬åœ° API æµ‹è¯•å¤±è´¥</strong><br>
                            çŠ¶æ€: ${response.status}<br>
                            é”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><strong>ç½‘ç»œé”™è¯¯:</strong> ${error.message}</div>`;
            }
        }

        // æ ¹æ®åæ ‡æµ‹è¯•å¤©æ°”
        async function testWeatherByCoords(lat, lon) {
            const resultDiv = document.getElementById('weatherResult');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨ç”¨åæ ‡æµ‹è¯•å¤©æ°”...</div>';
            
            try {
                const response = await fetch(`https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${lat},${lon}&days=3`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>âœ… åæ ‡å¤©æ°”æµ‹è¯•æˆåŠŸ!</strong><br>
                            ä½ç½®: ${data.location.name}, ${data.location.country}<br>
                            æ¸©åº¦: ${data.current.temp_c}Â°C<br>
                            å¤©æ°”: ${data.current.condition.text}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <strong>âŒ åæ ‡å¤©æ°”æµ‹è¯•å¤±è´¥</strong><br>
                            çŠ¶æ€: ${response.status}<br>
                            é”™è¯¯: ${data.error?.message || 'æœªçŸ¥é”™è¯¯'}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><strong>ç½‘ç»œé”™è¯¯:</strong> ${error.message}</div>`;
            }
        }

        // æ£€æŸ¥ç¯å¢ƒ
        function checkEnvironment() {
            const resultDiv = document.getElementById('envResult');
            
            resultDiv.innerHTML = `
                <div class="info">
                    <strong>ç¯å¢ƒå˜é‡æ£€æŸ¥:</strong><br>
                    NODE_ENV: ${process.env.NODE_ENV || 'æœªå®šä¹‰'}<br>
                    REACT_APP_WEATHER_API_KEY: ${process.env.REACT_APP_WEATHER_API_KEY ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}<br>
                    <strong>æµè§ˆå™¨ä¿¡æ¯:</strong><br>
                    User Agent: ${navigator.userAgent}<br>
                    è¯­è¨€: ${navigator.language}<br>
                    åœ¨çº¿çŠ¶æ€: ${navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                </div>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            updateAppStatus();
            
            // è‡ªåŠ¨æµ‹è¯•ç›´æ¥ API
            setTimeout(() => {
                testDirectAPI();
            }, 1000);
        });
    </script>
</body>
</html>